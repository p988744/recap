stages:
  - lint
  - test
  - build
  - release

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"

cache:
  paths:
    - .cache/pip
    - .cache/uv
    - .venv

.python-setup: &python-setup
  image: python:3.11-slim
  before_script:
    - pip install uv
    - uv venv .venv
    - source .venv/bin/activate
    - uv pip install -e ".[dev]"

# Lint stage
lint:
  <<: *python-setup
  stage: lint
  script:
    - ruff check .
    - ruff format --check .
  allow_failure: true

# Test stage
test:
  <<: *python-setup
  stage: test
  script:
    - pytest -v --tb=short --cov=tempo_sync --cov-report=term-missing
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    when: always

# Build stage
build:
  <<: *python-setup
  stage: build
  script:
    - uv pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - tags

# Release stage - creates GitLab release for tags
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## Tempo Sync $CI_COMMIT_TAG

      ### 安裝

      ```bash
      pip install tempo-sync
      ```

      ### 變更內容

      請參閱 [CHANGELOG.md](CHANGELOG.md) 或 commit history。
  only:
    - tags

# Optional: Publish to PyPI (需要設定 CI/CD Variables)
# publish:
#   <<: *python-setup
#   stage: release
#   script:
#     - uv pip install twine
#     - python -m build
#     - twine upload dist/*
#   only:
#     - tags
#   when: manual

# Background Sync v1 設計文件

## 概述

實作背景同步功能，讓 Recap 可以在系統托盤常駐並定時自動同步工作記錄。

## 需求摘要

| 項目 | 決定 |
|------|------|
| 同步方式 | 定時自動同步 |
| 執行時機 | 系統託盤常駐（縮小後繼續運作） |
| 同步間隔 | 可設定（5 / 15 / 30 / 60 分鐘） |
| 通知方式 | 靜默同步，只在出錯時通知 |
| 同步來源 | 使用者可選，預設本地（Git + Claude） |

## 架構設計

### 系統託盤整合

```
┌─────────────────────────────────────────────┐
│  Recap 主視窗                                │
│  - 關閉視窗 (X) → 縮小到系統托盤，不是退出    │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  系統托盤圖示 (macOS Menu Bar)              │
│  ┌──────────────────┐                       │
│  │ 🔄 Recap         │ ← 點擊顯示選單        │
│  ├──────────────────┤                       │
│  │ 開啟 Recap       │                       │
│  │ 立即同步         │                       │
│  │ ──────────────── │                       │
│  │ 上次同步: 10:30  │                       │
│  │ ──────────────── │                       │
│  │ 結束 Recap       │ ← 完全退出應用程式     │
│  └──────────────────┘                       │
└─────────────────────────────────────────────┘
```

### 背景同步服務

```
┌─────────────────────────────────────────────────────────┐
│  Tauri Backend (Rust)                                   │
│  ┌───────────────────────────────────────────────────┐  │
│  │  BackgroundSyncService                            │  │
│  │  ┌─────────────┐    ┌─────────────────────────┐   │  │
│  │  │ Timer       │───►│ SyncScheduler           │   │  │
│  │  │ (tokio)     │    │ - check interval        │   │  │
│  │  └─────────────┘    │ - get enabled sources   │   │  │
│  │                     │ - execute sync          │   │  │
│  │                     └───────────┬─────────────┘   │  │
│  │                                 │                 │  │
│  │                     ┌───────────▼─────────────┐   │  │
│  │                     │ SyncExecutor            │   │  │
│  │                     │ - sync_git()            │   │  │
│  │                     │ - sync_claude()         │   │  │
│  │                     │ - sync_gitlab()         │   │  │
│  │                     │ - sync_jira()           │   │  │
│  │                     └───────────┬─────────────┘   │  │
│  │                                 │                 │  │
│  │                     ┌───────────▼─────────────┐   │  │
│  │                     │ NotificationService     │   │  │
│  │                     │ - on_error() → 系統通知  │   │  │
│  │                     └─────────────────────────┘   │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 設定頁面 UI

```
┌─────────────────────────────────────────┐
│ 背景同步                                 │
│ ─────────────────────────────────────── │
│                                         │
│ ☑ 啟用背景同步                           │
│                                         │
│ 同步間隔                                 │
│ ┌─────────────────────┐                 │
│ │ 15 分鐘           ▼ │                 │
│ └─────────────────────┘                 │
│                                         │
│ 同步來源                                 │
│ ☑ Git 本地倉庫        (預設開啟)         │
│ ☑ Claude Code         (預設開啟)         │
│ ☐ GitLab              (需設定連線)       │
│ ☐ Jira/Tempo          (需設定連線)       │
│                                         │
│ 上次同步: 2026-01-16 16:30             │
│ 下次同步: 2026-01-16 16:45             │
└─────────────────────────────────────────┘
```

### 設定儲存

```rust
struct BackgroundSyncConfig {
    enabled: bool,              // 預設 true
    interval_minutes: i32,      // 預設 15
    sync_git: bool,             // 預設 true
    sync_claude: bool,          // 預設 true
    sync_gitlab: bool,          // 預設 false
    sync_jira: bool,            // 預設 false
}
```

## 錯誤處理

| 錯誤類型 | 通知? | 處理方式 |
|----------|-------|----------|
| 網路錯誤 | ❌ | 靜默跳過，下次重試 |
| 認證過期 | ✅ | 通知 + 引導設定 |
| 來源不存在 | ✅ | 通知 + 自動停用 |
| API 錯誤 | ✅ | 通知 + 記錄日誌 |
| 部分失敗 | ✅ | 彙總錯誤通知 |

## 實作計劃

| Phase | 任務 | Issue |
|-------|------|-------|
| Phase 1 | 系統托盤基礎設施 | #21 |
| Phase 2 | 背景同步服務核心 | #22 |
| Phase 3 | 設定頁面 UI | #23 |
| Phase 4 | 錯誤通知整合 | #24 |
| Phase 5 | 測試與文件 | #25 |

## 技術依賴

- `tauri-plugin-system-tray` - 系統托盤
- `tauri-plugin-notification` - 系統通知
- `tokio` - 非同步定時器

## Milestone

- GitHub Milestone: [Background Sync v1](https://github.com/p988744/recap/milestone/3)

---

> 建立日期: 2026-01-16
> 狀態: 設計完成，待實作
